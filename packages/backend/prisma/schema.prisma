// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum RiskTolerance {
  conservative
  moderate
  aggressive
}

enum ProgressStatus {
  not_started
  in_progress
  completed
}

enum ContentType {
  text
  video
  interactive
  calculator
  ai_prompt
}

enum GoalStatus {
  active
  completed
  paused
  abandoned
}

enum EntryType {
  free_form
  module_reflection
  goal
  daily_checkin
  prompted
}

enum PromptCategory {
  money_mindset
  goal_setting
  challenges
  gratitude
  future_vision
  reflection
  celebration
}

enum TriggerType {
  module_complete
  goal_created
  goal_milestone
  mood_low
  streak
  time_based
  random
  onboarding
}

enum Theme {
  light
  dark
  auto
}

enum Season {
  spring
  summer
  autumn
  winter
}

enum ReflectionRequired {
  full
  hybrid
  none
}

enum UserRole {
  user
  admin

  @@map("userrole")
}

// User Models
model User {
  id                String      @id @default(uuid())
  email             String      @unique @db.VarChar(255)
  password_hash     String      @db.VarChar(255)
  name              String      @db.VarChar(255)
  role              UserRole    @default(user)
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  last_login        DateTime?
  profile_completed Boolean     @default(false)

  // Relations
  profile           UserProfile?
  progress          UserProgress[]
  section_progress  SectionProgress[]
  calculators       CalculatorData[]
  goals             UserGoal[]
  achievements      Achievement[]
  conversations     AIConversation[]
  journal_entries   JournalEntry[]
  mood_entries      MoodEntry[]
  preferences       UserPreferences?
  journaling_streak JournalingStreak?

  // Educational Enhancement Relations
  learning_performances      LearningPerformance[]
  learning_style             LearningStyle?
  concept_masteries          ConceptMastery[]
  stress_predictions         StressPrediction[]
  learning_interventions     LearningIntervention[]
  module_readiness           ModuleReadiness[]
  reflective_thinking_processes ReflectiveThinkingProcess[]
  reflective_hypotheses       ReflectiveHypothesis[]
  habits_of_mind             HabitsOfMind[]
  language_activities        LanguageActivity[]

  @@index([email])
  @@index([role])
  @@index([last_login])
  @@index([created_at])
  @@map("users")
}

model UserProfile {
  id                  String          @id @default(uuid())
  user_id             String          @unique
  age                 Int?
  current_income      Decimal?        @db.Decimal(12, 2)
  financial_goals     String[]
  risk_tolerance      RiskTolerance?
  has_debt            Boolean         @default(false)
  has_emergency_fund  Boolean         @default(false)
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("user_profiles")
}

// Module Models
model Module {
  id                  String            @id @default(uuid())
  phase_number        Int
  module_number       Int
  title               String            @db.VarChar(255)
  description         String?           @db.Text
  estimated_duration  Int?
  order_index         Int
  prerequisites       String[]
  reflection_required ReflectionRequired @default(none)
  created_at          DateTime          @default(now())

  // Relations
  content         ModuleContent[]
  progress        UserProgress[]
  calculators     CalculatorData[]
  conversations   AIConversation[]
  journal_entries JournalEntry[]

  // Educational Enhancement Relations
  learning_performances      LearningPerformance[]
  stress_predictions         StressPrediction[]
  learning_interventions     LearningIntervention[]
  module_readiness           ModuleReadiness[]
  reflective_thinking_processes ReflectiveThinkingProcess[]
  habits_of_mind             HabitsOfMind[]
  language_activities        LanguageActivity[]

  @@unique([phase_number, module_number])
  @@index([phase_number])
  @@index([order_index])
  @@index([reflection_required])
  @@map("modules")
}

model ModuleContent {
  id              String      @id @default(uuid())
  module_id       String
  section_number  Int
  section_title   String      @db.VarChar(255)
  content_type    ContentType
  content_data    Json
  order_index     Int
  created_at      DateTime    @default(now())

  // Relations
  module           Module            @relation(fields: [module_id], references: [id], onDelete: Cascade)
  section_progress SectionProgress[]

  @@index([module_id])
  @@index([order_index])
  @@map("module_content")
}

// Progress Models
model UserProgress {
  id                   String         @id @default(uuid())
  user_id              String
  module_id            String
  status               ProgressStatus @default(not_started)
  progress_percentage  Int            @default(0)
  started_at           DateTime?
  completed_at         DateTime?
  last_accessed        DateTime?
  time_spent_minutes   Int            @default(0)
  created_at           DateTime       @default(now())
  updated_at           DateTime       @updatedAt

  // New Adaptive Learning Fields
  learning_style_detected Boolean     @default(false)
  adaptive_path_taken     String?     @db.VarChar(50) // 'fast' | 'standard' | 'thorough' | 'remedial'
  mastery_level           Decimal?    @db.Decimal(5, 2) // 0-100
  readiness_score         Decimal?    @db.Decimal(5, 2) // 0-100

  // Performance Tracking
  average_time_per_section Int?
  error_rate              Decimal?    @db.Decimal(5, 2)
  engagement_score        Decimal?    @db.Decimal(5, 2)

  // Relations
  user   User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module Module @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([user_id, module_id])
  @@index([user_id])
  @@index([module_id])
  @@index([status])
  @@map("user_progress")
}

model SectionProgress {
  id                String    @id @default(uuid())
  user_id           String
  module_content_id String
  completed         Boolean   @default(false)
  completed_at      DateTime?
  notes             String?   @db.Text
  created_at        DateTime  @default(now())

  // Relations
  user           User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module_content ModuleContent @relation(fields: [module_content_id], references: [id], onDelete: Cascade)

  @@unique([user_id, module_content_id])
  @@index([user_id])
  @@index([module_content_id])
  @@map("section_progress")
}

// Calculator Models
model CalculatorData {
  id              String   @id @default(uuid())
  user_id         String
  calculator_type String   @db.VarChar(100)
  calculator_name String   @db.VarChar(255)
  input_data      Json
  output_data     Json
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  module_id       String?

  // Relations
  user   User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module Module? @relation(fields: [module_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([calculator_type])
  @@index([module_id])
  @@map("calculator_data")
}

// Goal Models
model UserGoal {
  id               String     @id @default(uuid())
  user_id          String
  goal_type        String     @db.VarChar(100)
  title            String     @db.VarChar(255)
  description      String?    @db.Text
  target_amount    Decimal?   @db.Decimal(12, 2)
  target_date      DateTime?  @db.Date
  current_progress Decimal    @default(0) @db.Decimal(12, 2)
  status           GoalStatus @default(active)
  milestones       Json?      @db.JsonB
  created_at       DateTime   @default(now())
  updated_at       DateTime   @updatedAt

  // Relations
  user            User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  journal_entries JournalEntry[]

  @@index([user_id])
  @@index([status])
  @@map("user_goals")
}

// Achievement Models
model Achievement {
  id               String   @id @default(uuid())
  user_id          String
  achievement_type String   @db.VarChar(100)
  title            String   @db.VarChar(255)
  description      String?  @db.Text
  earned_at        DateTime @default(now())
  metadata         Json?

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([achievement_type])
  @@map("achievements")
}

// AI Models
model AIConversation {
  id                   String   @id @default(uuid())
  user_id              String
  module_id            String?
  conversation_context String?  @db.VarChar(255)
  messages             Json
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  user   User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module Module? @relation(fields: [module_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([module_id])
  @@map("ai_conversations")
}

// Journal Models
model JournalEntry {
  id            String     @id @default(uuid())
  user_id       String
  entry_type    EntryType
  title         String?    @db.VarChar(500)
  content       Json       @db.JsonB
  mood          Int?       @db.SmallInt
  stress_level  Int?       @db.SmallInt
  energy_level  Int?       @db.SmallInt
  word_count    Int        @default(0)

  // Associations
  module_id     String?
  goal_id       String?
  prompt_id     String?

  // Metadata
  tags          String[]
  is_favorite   Boolean    @default(false)
  is_private    Boolean    @default(true)
  share_token   String?    @unique @db.VarChar(50)

  // Timestamps
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  deleted_at    DateTime?

  // Relations
  user   User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module Module?       @relation(fields: [module_id], references: [id], onDelete: SetNull)
  goal   UserGoal?     @relation(fields: [goal_id], references: [id], onDelete: SetNull)
  prompt JournalPrompt? @relation(fields: [prompt_id], references: [id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@index([user_id, entry_type])
  @@index([user_id, mood])
  @@index([share_token])
  @@map("journal_entries")
}

model JournalPrompt {
  id              String         @id @default(uuid())
  prompt_text     String         @db.Text
  category        PromptCategory
  subcategory     String?        @db.VarChar(100)

  // Targeting
  trigger_type    TriggerType
  trigger_config  Json?          @db.JsonB

  // Personalization
  uses_name       Boolean        @default(false)
  uses_goal_data  Boolean        @default(false)
  min_engagement  Int?

  // Metadata
  is_active       Boolean        @default(true)
  priority        Int            @default(0)
  created_at      DateTime       @default(now())

  // Relations
  entries JournalEntry[]

  @@index([category, is_active])
  @@index([trigger_type, is_active])
  @@map("journal_prompts")
}

model MoodEntry {
  id               String   @id @default(uuid())
  user_id          String

  // Mood data
  overall_mood     Int      @db.SmallInt
  financial_stress Int      @db.SmallInt
  energy_level     Int?     @db.SmallInt
  note             String?  @db.Text

  // Context
  journaled_today  Boolean  @default(false)
  completed_module Boolean  @default(false)
  worked_on_goal   Boolean  @default(false)

  created_at       DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, overall_mood])
  @@index([created_at])
  @@map("mood_entries")
}

model UserPreferences {
  id                    String   @id @default(uuid())
  user_id               String   @unique

  // Theme
  theme                 Theme    @default(auto)
  seasonal_theme        Boolean  @default(true)
  time_based_theme      Boolean  @default(true)
  preferred_season      Season?

  // Sound
  soundscape_enabled    Boolean  @default(false)
  soundscape_type       String?  @db.VarChar(50)
  soundscape_volume     Float    @default(0.5)
  sound_effects_enabled Boolean  @default(true)

  // Notifications
  journal_reminders     Boolean  @default(true)
  reminder_time         String?  @db.VarChar(10)
  reminder_frequency    String   @default("daily") @db.VarChar(20)

  // Content
  show_stress_exercises Boolean  @default(true)
  content_pacing        String   @default("medium") @db.VarChar(20)

  // Accessibility
  reduce_motion         Boolean  @default(false)
  high_contrast         Boolean  @default(false)
  font_size_adjust      Int      @default(0) @db.SmallInt

  updated_at            DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model JournalingStreak {
  id              String    @id @default(uuid())
  user_id         String    @unique

  current_streak  Int       @default(0)
  longest_streak  Int       @default(0)
  total_entries   Int       @default(0)

  last_entry_date DateTime?
  streak_started  DateTime?

  updated_at      DateTime  @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("journaling_streaks")
}

// Educational Enhancement Models

model LearningPerformance {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String
  section_id            String?
  concept_id            String?

  // Performance Metrics
  time_spent_seconds    Int
  attempts              Int       @default(1)
  assessment_score     Decimal?  @db.Decimal(5, 2)
  error_count           Int       @default(0)
  error_patterns        Json?     // Array of error types
  completion_status     String   // 'completed' | 'abandoned' | 'in_progress'

  // Learning Indicators
  notes_taken           Boolean  @default(false)
  content_reviewed      Int      @default(0) // Number of times reviewed
  interactive_engaged   Boolean  @default(false)

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@index([user_id, module_id])
  @@index([user_id, created_at])
  @@index([concept_id])
  @@map("learning_performance")
}

model LearningStyle {
  id                    String   @id @default(uuid())
  user_id               String   @unique

  // Detected Preferences
  visual_preference     Int      @default(50) // 0-100
  textual_preference    Int      @default(50)
  interactive_preference Int     @default(50)
  pace_preference       String   @default("moderate") @db.VarChar(20) // 'fast' | 'moderate' | 'thorough'

  // Behavioral Patterns
  preferred_time_of_day String?  @db.VarChar(50)
  average_session_length Int?     // minutes
  review_frequency      String   @default("medium") @db.VarChar(20) // 'high' | 'medium' | 'low'

  // Detection Method
  detection_method      String   @default("behavioral") @db.VarChar(20) // 'behavioral' | 'explicit'
  confidence            Decimal  @default(0.5) @db.Decimal(3, 2) // 0-1

  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("learning_style")
}

model ConceptMastery {
  id                    String   @id @default(uuid())
  user_id               String
  concept_id            String

  // Mastery Tracking
  mastery_level         Decimal  @default(0) @db.Decimal(5, 2) // 0-100
  assessment_history    Json     // Array of assessment scores
  last_assessed         DateTime?
  next_review_date      DateTime?

  // Spaced Repetition
  spaced_interval_days  Int      @default(1)
  review_count          Int      @default(0)

  // Mastery Status
  status                String   @default("not_started") @db.VarChar(50) // 'not_started' | 'learning' | 'mastered' | 'needs_review'

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, concept_id])
  @@index([user_id, status])
  @@index([next_review_date])
  @@map("concept_mastery")
}

model StressPrediction {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String?

  // Prediction Data
  predicted_stress_level Int     // 1-10
  confidence            Decimal  @db.Decimal(3, 2) // 0-1
  factors               Json     // Prediction factors

  // Actual Outcome (for model improvement)
  actual_stress_level   Int?
  prediction_accuracy   Decimal? @db.Decimal(3, 2)

  // Recommendations
  recommendations       Json     // Array of recommendations

  created_at            DateTime @default(now())

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module?  @relation(fields: [module_id], references: [id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@map("stress_predictions")
}

model LearningIntervention {
  id                    String   @id @default(uuid())
  user_id               String
  intervention_type     String   @db.VarChar(50) // 'hint' | 'encouragement' | 'break' | 'celebration' | 'remediation'

  // Context
  module_id             String?
  section_id            String?
  trigger_reason        String   @db.VarChar(255)
  trigger_conditions    Json

  // Intervention Data
  content               Json     // Intervention-specific content
  displayed             Boolean  @default(false)
  acknowledged          Boolean  @default(false)

  // Effectiveness
  user_response         String?  @db.VarChar(50) // 'helpful' | 'not_helpful' | 'dismissed'
  outcome               Json?    // Result of intervention

  created_at            DateTime @default(now())
  displayed_at          DateTime?
  acknowledged_at       DateTime?

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module?  @relation(fields: [module_id], references: [id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@index([intervention_type])
  @@map("learning_interventions")
}

model ModuleReadiness {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String

  // Readiness Assessment
  prerequisite_status   Json     // Status of each prerequisite
  emotional_readiness   String   @db.VarChar(50) // 'optimal' | 'good' | 'moderate' | 'poor'
  time_available        Int?     // minutes

  // Recommendations
  can_proceed           Boolean
  recommendations       Json     // Array of recommendations
  optimal_timing        String?  @db.VarChar(255)

  assessed_at           DateTime @default(now())

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([user_id, module_id])
  @@index([user_id, can_proceed])
  @@map("module_readiness")
}

model ReflectiveThinkingProcess {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String
  section_id            String?

  // Step 1: Felt Difficulty
  problematic_situation Json     // ProblematicSituation data
  user_reaction         String?  @db.VarChar(50) // 'surprised' | 'confused' | 'contradicted' | 'curious'
  engagement_level      Int?     // 1-10

  // Step 2: Problem Definition
  initial_problem       String?  @db.Text
  refined_problem       String?  @db.Text
  problem_definition_complete Boolean @default(false)

  // Step 3: Hypothesis Generation
  user_hypotheses       Json     // Array of user-generated hypotheses
  alternative_hypotheses Json?   // System-suggested alternatives
  selected_hypothesis    String?  @db.Text

  // Step 4: Reasoning
  evidence_gathered     Json?    // Sources and analysis
  consequence_analysis  Json?    // If-then reasoning
  logical_reasoning     String?  @db.Text

  // Step 5: Testing
  action_plan           String?  @db.Text
  calculator_used       String?  @db.VarChar(100)
  real_world_applied    Boolean  @default(false)
  test_results          Json?    // Results of testing
  reflection_on_results String?  @db.Text

  // Process Status
  current_step          Int      @default(1) // 1-5
  completed             Boolean  @default(false)

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
  completed_at          DateTime?

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)
  hypotheses            ReflectiveHypothesis[]

  @@index([user_id, module_id])
  @@index([user_id, current_step])
  @@index([completed])
  @@map("reflective_thinking_process")
}

model ReflectiveHypothesis {
  id                    String   @id @default(uuid())
  process_id            String
  user_id               String

  // Hypothesis Data
  hypothesis_text       String   @db.Text
  source                String   @default("user") @db.VarChar(20) // 'user' | 'system' | 'combined'

  // Evaluation
  feasibility_score     Int?     // 1-10
  impact_score          Int?     // 1-10
  sustainability_score  Int?     // 1-10

  // Reasoning
  supporting_evidence   Json?    // Evidence that supports
  opposing_evidence     Json?    // Evidence that challenges
  consequences_if_true  Json?    // Array of consequences
  consequences_if_false Json?    // Array of consequences

  // Status
  status                String   @default("generated") @db.VarChar(50) // 'generated' | 'evaluated' | 'selected' | 'tested' | 'rejected'
  selected_for_testing  Boolean  @default(false)

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  process               ReflectiveThinkingProcess @relation(fields: [process_id], references: [id], onDelete: Cascade)
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([process_id])
  @@index([user_id, status])
  @@map("reflective_hypothesis")
}

model HabitsOfMind {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String?

  // Open-mindedness
  open_mindedness_score Decimal  @default(0) @db.Decimal(5, 2) // 0-100
  considers_alternatives Boolean @default(false)
  questions_assumptions Boolean @default(false)
  explores_solutions    Boolean @default(false)

  // Responsibility
  responsibility_score  Decimal  @default(0) @db.Decimal(5, 2) // 0-100
  considers_consequences Boolean @default(false)
  takes_ownership       Boolean @default(false)
  applies_personally    Boolean @default(false)

  // Whole-heartedness
  whole_heartedness_score Decimal @default(0) @db.Decimal(5, 2) // 0-100
  engagement_level      Int      @default(0) // 0-10
  curiosity_demonstrated Boolean @default(false)
  attention_sustained   Boolean @default(false)

  // Context
  assessment_type       String   @db.VarChar(50) // 'module' | 'section' | 'activity' | 'overall'
  activity_id           String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module?  @relation(fields: [module_id], references: [id], onDelete: SetNull)

  @@index([user_id, module_id])
  @@index([user_id, created_at])
  @@map("habits_of_mind")
}

model LanguageActivity {
  id                    String   @id @default(uuid())
  user_id               String
  module_id             String
  section_id            String?

  // Activity Type
  activity_type         String   @db.VarChar(50) // 'articulation' | 'hypothesis_writing' | 'reflection' | 'concept_mapping' | 'explanation'

  // User Response
  user_response         String   @db.Text
  required_elements     Json     // Which elements were required
  elements_completed    Json     // Which elements user completed

  // Assessment
  clarity_score         Decimal? @db.Decimal(5, 2) // 0-100
  completeness_score    Decimal? @db.Decimal(5, 2) // 0-100
  reasoning_quality      Decimal? @db.Decimal(5, 2) // 0-100
  overall_score         Decimal? @db.Decimal(5, 2) // 0-100

  // Feedback
  feedback_provided     Boolean  @default(false)
  feedback_content      String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  module                Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@index([user_id, module_id])
  @@index([activity_type])
  @@index([created_at])
  @@map("language_activities")
}
